{% extends 'base.html' %}
{% load cents_to_dollars %}

{% block title %}sponsoredissues.org - {{ owner }}{% endblock %}

{% block head %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #495057;
        line-height: 1.6;
    }

    .repo-header {
        background: white;
        padding: 16px 0;
        margin-bottom: 0;
    }

    .repo-header-content {
        margin: 0 auto;
        padding: 0 20px;
    }

    .repo-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .owner-avatar-link {
        display: flex;
        align-items: center;
        text-decoration: none;
        transition: opacity 0.2s ease;
    }

    .owner-avatar-link:hover {
        opacity: 0.8;
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
    }

    .repo-header h1 {
        font-size: 1.75rem;
        color: #1e3a8a;
        font-weight: 700;
        margin: 0px 8px 0px 0px;
    }

    .repo-header h1 a {
        color: #1e3a8a;
        text-decoration: none;
    }

    .repo-header h1 a:hover {
        text-decoration: underline;
    }

    .sponsor-btn {
        background: #ea4aaa22;
        color: #ea4aaa;
        border: 1px solid #ea4aaa;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .sponsor-btn:hover {
        background: #ea4aaa;
        color: white;
    }

    .sponsor-btn.disabled {
        background: #f1f5f9;
        color: #94a3b8;
        border: 1px solid #cbd5e1;
        cursor: not-allowed;
        pointer-events: none;
    }

    .sponsor-btn-wrapper {
        position: relative;
        display: inline-block;
    }

    .sponsor-btn-wrapper .tooltip {
        visibility: hidden;
        background-color: #1f2937;
        color: white;
        text-align: center;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .sponsor-btn-wrapper:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }

    .sponsor-stats {
        margin: 12px 0px 0px 0px;
    }

    /* Compact stats bar */
    .sponsor-stats-bar {
        background: linear-gradient(to right, #f8fafc, #f1f5f9);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-icon {
        font-size: 1.1rem;
        filter: grayscale(0.3);
    }

    .stat-content {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e3a8a;
    }

    .stat-separator {
        width: 1px;
        height: 32px;
        background: #cbd5e1;
    }

    .sponsor-stat.message {
        font-style: italic;
    }

    .sponsor-stat.message a {
        color: #1e3a8a;
        font-weight: 700;
        text-decoration: none;
    }

    .sponsor-stat.message a:hover {
        text-decoration: underline;
    }

    .sponsor-stat.message .link-btn {
        background: none;
        border: none;
        padding: 0;
        color: #1e3a8a;
        font-weight: 700;
        text-decoration: none;
        cursor: pointer;
        font: inherit;
    }

    .sponsor-stat.message .link-btn:hover {
        text-decoration: underline;
    }

    .github_username {
        color: #1e3a8a;
        font-weight: 600;
    }

    .issues-list {
        background: white;
        border-top: 1px solid #6b728055;
        border-bottom: 1px solid #6b728055;
        overflow: hidden;
    }

    .issue-item {
        display: flex;
        align-items: center;
        padding: 12px 24px;
        border-bottom: 1px solid #6b728055;
        transition: background-color 0.2s ease;
        gap: 16px;
    }

    .issue-item:last-child {
        border-bottom: none;
    }

    .issue-item:hover {
        background: #f8fafc;
    }

    .issue-item.is_selected {
        background: #f1f5f9;
        animation: highlight-fade 0.3s ease-out;
    }

    @keyframes highlight-fade {
        0% {
            background: #e2e8f0;
        }
        100% {
            background: #f1f5f9;
        }
    }

    .rank-section {
        flex-shrink: 0;
        width: 60px;
        text-align: center;
    }

    .rank {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e3a8a;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
        display: inline-block;
    }


    .issue-main {
        flex: 1;
        min-width: 0;
    }

    .issue-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .issue-title a {
        color: #1e3a8a;
        text-decoration: none;
    }

    .issue-title a:hover {
        text-decoration: underline;
    }

    .issue-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .labels {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .label {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid transparent;
    }

    .issue-number {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .issue-number a {
        color: #6b7280;
        text-decoration: none;
    }

    .issue-number a:hover {
        color: #6b7280;
        text-decoration: underline;
    }

    .donation-section {
        flex-shrink: 0;
        text-align: right;
        min-width: 120px;
    }

    .donation-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e3a8a;
        background: #f3f4f6;
        padding: 6px 10px;
        border-radius: 6px;
        display: inline-block;
    }

    .num-sponsors {
        font-size: 0.9rem;
        font-weight: 500;
        color: #1e3a8a;
        margin-bottom: 2px;
    }

    .your-amount {
        font-size: 0.9rem;
        color: #6b7280;
    }

    .action-section {
        flex-shrink: 0;
    }

    .donate-btn {
        /* background: #1e3a8a22; */
        background: #e8eef5;
        padding: 8px 12px;
        color: #1e3a8a;
        border: 1px solid #1e3a8a;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .donate-btn:hover {
        background: #1e40af;
        color: white;
        transform: translateY(-1px);
    }

    .donate-btn:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        border: 1px solid #cbd5e1;
        cursor: not-allowed;
    }

    .donate-btn:disabled:hover {
        background: #f1f5f9;
        color: #94a3b8;
        transform: none;
    }
    .no-issues {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
        position: relative;
    }

    .modal-title {
        color: #111827;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .issue-link {
        color: #6b7280;
        font-size: 0.9rem;
        text-decoration: none;
        margin-bottom: 16px;
    }

    .total-container {
        text-align: center;
        margin-top: 24px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .total-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .total-amount {
        font-size: 1.75rem;
        font-weight: 700;
        color: #059669;
    }

    .donation-input-group {
        margin: 20px 0;
    }

    .donation-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 0.9rem;
    }

    .donation-amount-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
        transition: all 0.2s ease;
    }

    .donation-amount-input:focus {
        outline: none;
        border-color: #1e3a8a;
        box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    .donation-amount-input.error {
        border: 1px solid red;
    }

    .donation-input-group .donation-amount-error {
        color: red;
        margin-top: 4px;
        font-size: 0.875rem;
    }

    .cancel-btn {
        width: 100%;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        margin: 16px 0px 4px 0px;
    }

    .update-btn {
        width: 100%;
        background: #1e3a8a;
        color: white;
    }

    .close {
        color: #999;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

    .close:hover {
        color: #333;
    }

    @media (max-width: 768px) {
        .issue-item {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
            padding: 16px 20px;
        }

        .rank-section,
        .donation-section,
        .action-section {
            width: auto;
            text-align: left;
        }

        .sponsor-stats-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .stat-separator {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="repo-header">
    <div class="repo-header-content">
        <div class="repo-title-row">
            <a href="https://github.com/{{ owner }}" target="_blank" class="owner-avatar-link">
                <img src="https://github.com/{{ owner }}.png" alt="{{ owner }}" class="owner-avatar">
            </a>
            <h1><a href="https://github.com/{{ owner }}" target="_blank">{{ owner }}</a>'s issues</h1>
            {% if has_sponsors_profile %}
            <a href="https://github.com/sponsors/{{ owner }}" target="_blank" class="sponsor-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5zM8 14.25l-.345.666-.002-.001-.006-.003-.018-.01a7.643 7.643 0 01-.31-.17 22.075 22.075 0 01-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.08 22.08 0 01-3.744 2.584l-.018.01-.006.003h-.002L8 14.25zm0 0l.345.666a.752.752 0 01-.69 0L8 14.25z"></path>
                </svg>
                Sponsor @{{ owner }}
            </a>
            {% else %}
            <div class="sponsor-btn-wrapper">
                <span class="sponsor-btn disabled">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5zM8 14.25l-.345.666-.002-.001-.006-.003-.018-.01a7.643 7.643 0 01-.31-.17 22.075 22.075 0 01-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.08 22.08 0 01-3.744 2.584l-.018.01-.006.003h-.002L8 14.25zm0 0l.345.666a.752.752 0 01-.69 0L8 14.25z"></path>
                    </svg>
                    Sponsor @{{ owner }}
                </span>
                <span class="tooltip">This GitHub user does not have a GitHub Sponsors profile.</span>
            </div>
            {% endif %}
        </div>
        {% if not user.is_authenticated %}
        <div class="sponsor-stats">
            <div class="sponsor-stat message">
                <form method="post" action="/accounts/github/login/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="link-btn">Sign in with GitHub</button>
                </form> to add or remove funds to issues.
            </div>
        </div>
        {% elif user.username != owner %}
            {% if total_sponsor_cents == 0 %}
            <div class="sponsor-stats">
                <div class="sponsor-stat message">
                    You haven't made any donations to <span class="github_username">@{{ owner }}</span> yet. To add funds to issues, <a href="https://github.com/sponsors/{{ owner }}" target="_blank">send @{{ owner }} a donation on GitHub Sponsors</a>.
                </div>
            </div>
            {% else %}
            <div class="sponsor-stats">
                <div class="sponsor-stats-bar">
                    <div class="stat-item">
                        <span class="stat-icon">ðŸ’°</span>
                        <div class="stat-content">
                            <span class="stat-label">Total Donated</span>
                            <span class="stat-value">{{ total_sponsor_cents|cents_to_dollars }} USD</span>
                        </div>
                    </div>

                    <div class="stat-separator"></div>

                    <div class="stat-item">
                        <span class="stat-icon">ðŸ“Œ</span>
                        <div class="stat-content">
                            <span class="stat-label">Assigned</span>
                            <span class="stat-value">{{ allocated_sponsor_cents|cents_to_dollars }} USD</span>
                        </div>
                    </div>

                    <div class="stat-separator"></div>

                    <div class="stat-item">
                        <span class="stat-icon">ðŸ’¸</span>
                        <div class="stat-content">
                            <span class="stat-label">Remaining</span>
                            <span class="stat-value">{{ unallocated_sponsor_cents|cents_to_dollars }} USD</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>


<div class="issues-list">
    {% if issues %}
        {% for issue in issues %}
        <div class="issue-item {% if issue.is_selected %}is_selected{% endif %}" id="issue-{{ issue.number }}" >
            <div class="rank-section">
                <div class="rank">#{{ issue.rank }}</div>
            </div>
            <div class="issue-main">
                <div class="issue-title"><a href="https://github.com/{{ owner }}/{{ issue.repo }}" class="repo-prefix" target="_blank">{{ owner }}/{{ issue.repo }}</a>: <a href="https://github.com/{{ owner }}/{{ issue.repo }}/issues/{{ issue.number }}" target="_blank">{{ issue.title }}</a></div>
                <div class="issue-meta">
                    <div class="labels">
                        {% for label in issue.labels %}
                        <span class="label" data-label-color="{{ label.color }}">{{ label.name }}</span>
                        {% endfor %}
                    </div>
                    <div class="issue-number"><a href="https://github.com/{{ owner }}/{{ issue.repo }}/issues/{{ issue.number }}" target="_blank">{{ owner }}/{{ issue.repo }}#{{ issue.number }}</a> {% if issue.state == 'open' %}(open){% else %}(closed){% endif %}</div>
                </div>
            </div>
            <div class="donation-section">
                <div class="donation-amount">{{ issue.donation_total_cents|cents_to_dollars }} USD</div>
                <div class="num-sponsors">{{ issue.num_sponsors }} sponsors</div>
                {% if user.is_authenticated and user.username != owner %}
                <div class="your-amount">You: {{ issue.user_donation_cents|cents_to_dollars }} USD</div>
                {% endif %}
            </div>
            <div class="action-section">
                <button class="donate-btn"
                    data-issue-repo="{{ issue.repo }}"
                    data-issue-number="{{ issue.number }}"
                    data-issue-title="{{ issue.title|escapejs }}"
                    data-issue-url="{{ issue.url }}"
                    data-user-donation="{{ issue.user_donation_cents }}"
                    data-total-donation="{{ issue.donation_total_cents }}"
                    onclick="openModal(this)"
                    {% if not user.is_authenticated or total_sponsor_cents == 0 or user.username == owner %}disabled{% endif %}>Add or Remove Funds</button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-issues">
            <h3>No sponsored issues found</h3>
            <p>This GitHub user has not created any sponsored issues.</p>
            <p>You can invite them to try <strong>sponsoredissues.org</strong>
               by submitting an issue to <a href="https://github.com/{{ owner }}" target="_blank">one of their GitHub repos</a>.</p>
        </div>
    {% endif %}
</div>

<!-- Modal -->
<div id="donateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title" id="modalTitle"></h3>
        <a class="issue-link" id="modalIssueLink" href="https://github.com/example/awesome-project/issues/42" target="_blank">example/awesome-project#42</a>
        <div class="total-container">
            <div class="total-label">
                New total
            </div>
            <div class="total-amount">
                0.00 USD
            </div>
        </div>
        <form id="donateForm" method="post">
            {% csrf_token %}
            <div class="donation-input-group">
                <label for="donationAmount">Your contribution<span id="oldAmountReminder"></span>:</label>
                <input type="number" id="donationAmount" name="donation_dollars" class="donation-amount-input"
                    value="0" min="0" step="1">
                <label for="donationAmount" id="donationAmountError" class="donation-amount-error"></label>
            </div>
            <button type="button" class="btn cancel-btn" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn update-btn">Update</button>
        </form>
    </div>
</div>

<script>
    let currentIssue = null;

    function openModal(button) {
        currentIssue = {
            repo: button.dataset.issueRepo,
            number: parseInt(button.dataset.issueNumber),
            title: button.dataset.issueTitle,
            url: button.dataset.issueUrl,
            user_donation_cents: parseInt(button.dataset.userDonation),
            donation_total_cents: parseInt(button.dataset.totalDonation)
        };

        const titleElement = document.getElementById('modalTitle');
        titleElement.innerHTML = currentIssue.title;

        const issueLinkElement = document.getElementById('modalIssueLink');
        issueLinkElement.innerHTML = `{{ owner }}/${currentIssue.repo}#${currentIssue.number}`
        issueLinkElement.href = currentIssue.url;

        const donationInput = document.getElementById('donationAmount');
        donationInput.value = cents_to_dollars(currentIssue.user_donation_cents);
        donationInput.max = cents_to_dollars(currentIssue.user_donation_cents + {{ unallocated_sponsor_cents }})

        const donateForm = document.getElementById('donateForm');
        donateForm.action = "{% url 'donate_to_issue' owner '__REPO__' 1 %}"
            .replace('__REPO__', currentIssue.repo)
            .replace('1', currentIssue.number.toString());

        document.getElementById('donateModal').style.display = 'block';

        updateTotal();
    }

    function closeModal() {
        document.getElementById('donateModal').style.display = 'none';
    }

    function updateTotal() {
        const donationInput = document.getElementById('donationAmount');

        const totalElement = document.querySelector('.total-amount');
        const donationAmountError = document.getElementById('donationAmountError');

        const donation_cents = dollars_to_cents(donationInput.value);

        // If user types in a number that is greater than their
        // sponsor dollars remaining, show an error message and
        // reset the displayed total.
        var donation_delta = donation_cents - currentIssue.user_donation_cents;
        if (donation_delta > {{ unallocated_sponsor_cents }}) {
            donationInput.classList.add('error')
            donationAmountError.textContent = 'Exceeded sponsor dollars remaining';
            // Show original total and dollars remaining while input
            // box is in error state
            donation_delta = 0;
        } else {
            // Donation amount is okay, so clear any previously displayed error
            donationInput.classList.remove('error')
            donationAmountError.textContent = '';
        }

        // If the user changed their donation amount, or they have entered
        // invalid input into the amount box, remind them what their original
        // donation amount was.
        const oldAmountReminder = document.getElementById('oldAmountReminder');
        if (donation_delta !== 0 || donationInput.classList.contains('error')) {
            const old_amount_dollars = cents_to_dollars(currentIssue.user_donation_cents);
            oldAmountReminder.textContent = ` (was ${old_amount_dollars} USD)`;
        } else {
            oldAmountReminder.textContent = ''
        }

        const new_total_cents = currentIssue.donation_total_cents + donation_delta;
        totalElement.textContent = cents_to_dollars(new_total_cents) + ' USD';

        const dollars_remaining = document.getElementById('dollars_remaining');
        const cents_remaining = {{ unallocated_sponsor_cents }} - donation_delta;
        dollars_remaining.textContent = cents_to_dollars(cents_remaining);
    }

    // Convert a dollars USD value given as a string
    // to an equivalent integer cents value.
    //
    // Return zero if the input string doesn't represent
    // a valid dollar value (e.g. non-numeric characters).
    //
    // The input dollars value may be a whole number
    // (zero decimal places), or may have any number
    // of decimal places following the '.'. In the case that the
    // there are more than two decimal places, use "Banker's Rounding".
    function dollars_to_cents(dollarString) {
        // Remove whitespace and validate input
        const cleaned = String(dollarString).trim();
        if (!cleaned || !/^-?\d*\.?\d*$/.test(cleaned)) {
            return 0;
        }

        // Split on decimal point
        const parts = cleaned.split('.');
        const wholePart = parts[0] || '0';
        const decimalPart = parts[1] || '';

        // Convert whole dollars to cents
        let cents = parseInt(wholePart) * 100;
        if (isNaN(cents)) {
            return 0;
        }

        // Handle decimal part
        if (decimalPart.length === 0) {
            // No decimal part
            return cents;
        } else if (decimalPart.length === 1) {
            // One decimal place
            cents += parseInt(decimalPart) * 10;
        } else if (decimalPart.length === 2) {
            // Two decimal places
            cents += parseInt(decimalPart);
        } else {
            console.log("a")
            // More than two decimal places - use "Banker's Rounding"
            cents += parseInt(decimalPart.substring(0, 2));
            thirdDigit = parseInt(decimalPart.charAt(2))

            if (thirdDigit > 5) {
                cents += 1;
            } else if (thirdDigit === 5) {
                // Check if there any non-zero digits after the 5
                const hasMoreDigits = decimalPart.length > 3 && decimalPart.substring(3).match(/[1-9]/);
                // Note: Checking if `cents` is even/odd
                // is equivalent to checking if the second digit
                // is even/odd.
                if (hasMoreDigits || (cents % 2 === 1)) {
                    cents += 1;
                }
            }
        }

        return cents;
    }

    // Convert an integer value in cents to equivalent
    // dollars value as a string.
    //
    // Note: We use integer division/modulus instead of
    // `parseFloat` here, in order to floating-point precision
    // errors.
    function cents_to_dollars(cents) {
        const dollars = Math.floor(cents / 100);
        const remainingCents = cents % 100;
        return `${dollars}.${remainingCents.toString().padStart(2, '0')}`;
    }

    // Calculate the relative luminance of a color using WCAG guidelines.
    // Returns a value between 0 (black) and 1 (white).
    function getLuminance(hexColor) {
        // Remove # if present
        hexColor = hexColor.replace('#', '');

        // Convert hex to RGB
        const r = parseInt(hexColor.substring(0, 2), 16) / 255;
        const g = parseInt(hexColor.substring(2, 4), 16) / 255;
        const b = parseInt(hexColor.substring(4, 6), 16) / 255;

        // Apply gamma correction for each channel
        const rsRGB = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
        const gsRGB = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
        const bsRGB = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

        // Calculate and return luminance
        return 0.2126 * rsRGB + 0.7152 * gsRGB + 0.0722 * bsRGB;
    }

    // Convert hex color to rgba string with low opacity for soft backgrounds.
    // Lighter colors get higher opacity (30%), darker colors get lower opacity (15%).
    function hexToSoftRgba(hexColor) {
        // Remove # if present
        hexColor = hexColor.replace('#', '');

        // Convert hex to RGB
        const r = parseInt(hexColor.substring(0, 2), 16);
        const g = parseInt(hexColor.substring(2, 4), 16);
        const b = parseInt(hexColor.substring(4, 6), 16);

        // Use higher opacity for very light colors
        const luminance = getLuminance(hexColor);
        const opacity = luminance > 0.7 ? 0.3 : 0.15;

        return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }

    // Darken a hex color for use as text on soft background.
    // Lighter colors are darkened more, darker colors are darkened less.
    function darkenHexColor(hexColor) {
        // Remove # if present
        hexColor = hexColor.replace('#', '');

        // Convert hex to RGB
        let r = parseInt(hexColor.substring(0, 2), 16);
        let g = parseInt(hexColor.substring(2, 4), 16);
        let b = parseInt(hexColor.substring(4, 6), 16);

        // Determine darkening factor based on luminance
        const luminance = getLuminance(hexColor);
        let darkenFactor;
        if (luminance > 0.7) {
            // Very light colors: darken significantly (40% of original)
            darkenFactor = 0.4;
        } else if (luminance > 0.5) {
            // Medium-light colors: darken moderately (60% of original)
            darkenFactor = 0.6;
        } else {
            // Dark colors: darken slightly (80% of original)
            darkenFactor = 0.8;
        }

        // Apply darkening
        r = Math.floor(r * darkenFactor);
        g = Math.floor(g * darkenFactor);
        b = Math.floor(b * darkenFactor);

        // Convert back to hex
        const toHex = (n) => n.toString(16).padStart(2, '0');
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    // Add event listener to donation amount input
    document.addEventListener('DOMContentLoaded', function() {
        const donationInput = document.getElementById('donationAmount');
        donationInput.addEventListener('input', updateTotal);

        // Soften the default colors for the GitHub issue labels,
        // by making them semi-transparent.
        //
        // The default issue label colors are really varied and
        // really intense, which makes the web page as a whole
        // look really ugly and overwhelming.
        document.querySelectorAll('.label[data-label-color]').forEach(function(label) {
            const hexColor = label.getAttribute('data-label-color');
            const bgColor = hexToSoftRgba(hexColor);
            const textColor = darkenHexColor(hexColor);
            label.style.backgroundColor = bgColor;
            label.style.color = textColor;
        });
    });

</script>
{% endblock %}
